<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Online Pro Yƒ±lan - Tekil Rekorlar</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #game-wrapper { position: relative; border: 5px solid #333; box-shadow: 0 0 30px rgba(0,255,0,0.2); border-radius: 8px; width: 400px; height: 400px; }
        canvas { display: block; background: #111; border-radius: 5px; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; padding: 20px; box-sizing: border-box; }
        .hidden { display: none; }
        h1 { color: #39ff14; text-shadow: 0 0 10px #39ff14; font-size: 2em; margin: 0 0 15px 0; }
        .menu-buttons { display: flex; flex-direction: column; gap: 10px; width: 100%; align-items: center; }
        button { background: #39ff14; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 5px; width: 200px; font-size: 1em; transition: 0.2s; color: #000; }
        button:hover { background: #fff; transform: scale(1.05); }
        .leaderboard-container { width: 100%; margin-top: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 5px; box-sizing: border-box; max-height: 160px; overflow-y: auto; }
        .leaderboard-container::-webkit-scrollbar { width: 6px; }
        .leaderboard-container::-webkit-scrollbar-thumb { background: #39ff14; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { position: sticky; top: 0; background: #222; color: #39ff14; padding: 5px; text-align: left; }
        td { padding: 8px 5px; border-bottom: 1px solid #222; }
        .score-val { color: #39ff14; font-weight: bold; text-align: right; }
        #hud { position: absolute; top: 10px; left: 10px; font-size: 18px; font-weight: bold; color: #39ff14; z-index: 5; text-shadow: 1px 1px 2px #000; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="hud">Puan: 0</div>
    <div id="menu-screen" class="overlay">
        <h1>Pƒ∞KSEL YILAN</h1>
        <div class="menu-buttons">
            <button onclick="checkNameAndStart()">OYNA</button>
            <button onclick="showScreen('settings-screen')">AYARLAR</button>
        </div>
        <div class="leaderboard-container">
            <h3 style="margin: 5px 0; font-size: 14px; color: #39ff14; text-align: center;">üèÜ EN ƒ∞Yƒ∞ REKORLAR</h3>
            <table id="menu-leaderboard"></table>
        </div>
    </div>
    <div id="settings-screen" class="overlay hidden">
        <h2>ZORLUK SE√á</h2>
        <div class="menu-buttons">
            <button onclick="setDifficulty(180, 'KOLAY')">KOLAY</button>
            <button onclick="setDifficulty(100, 'ORTA')">ORTA</button>
            <button onclick="setDifficulty(60, 'ZOR')">ZOR</button>
            <button style="background:#555; color:#ddd;" onclick="showScreen('menu-screen')">GERƒ∞</button>
        </div>
    </div>
    <div id="gameover-screen" class="overlay hidden">
        <h1 style="color:#ff4444;">OYUN Bƒ∞TTƒ∞</h1>
        <h2 id="final-score-text">Skorun: 0</h2>
        <div class="menu-buttons">
            <button onclick="resetGame()">TEKRAR DENE</button>
            <button style="background:#555" onclick="backToMenu()">ANA MEN√ú</button>
        </div>
    </div>
    <canvas id="gameCanvas" width="400" height="400"></canvas>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const box = 20;
let gameInterval, score, snake, food, direction, isGameOver = false;
let gameSpeed = 100;
let playerName = localStorage.getItem("snakeName");

let assets = { bg: false, head: false, body: false, tail: false, apple: false };
const bgImg = new Image(); bgImg.src = 'arka_plan.jpg';
bgImg.onload = () => assets.bg = true;
const headImg = new Image(); headImg.src = 'yilan_kafa.png';
headImg.onload = () => assets.head = true;
const bodyImg = new Image(); bodyImg.src = 'yilan_govde.png';
bodyImg.onload = () => assets.body = true;
const tailImg = new Image(); tailImg.src = 'yilan_kuyruk.png';
tailImg.onload = () => assets.tail = true;
const appleImg = new Image(); appleImg.src = 'elma.png';
appleImg.onload = () => assets.apple = true;

const eatSound = new Audio('ye.mp3');
const bgMusic = new Audio('muzik.mp3');
bgMusic.loop = true;

const firebaseConfig = {
  apiKey: "AIzaSyAWdCEJgOQmP-1A4bvYNxmzWsfnfJQ6-vE",
  authDomain: "yilanoyunu-96766.firebaseapp.com",
  databaseURL: "https://yilanoyunu-96766-default-rtdb.firebaseio.com",
  projectId: "yilanoyunu-96766",
  storageBucket: "yilanoyunu-96766.firebasestorage.app",
  messagingSenderId: "87313077711",
  appId: "1:87313077711:web:6b90d8cbff959aa6a8eeba",
  measurementId: "G-7SH1LDS1JV"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- ANLIK Lƒ∞DERLƒ∞K TABLOSU ---
db.ref('scores').on('value', snap => {
    let scoresMap = {};
    snap.forEach(c => {
        let val = c.val();
        // Aynƒ± ki≈üi varsa en y√ºksek skoru tut
        if(!scoresMap[val.name] || val.score > scoresMap[val.name].score) {
            scoresMap[val.name] = val;
        }
    });
    let sortedScores = Object.values(scoresMap).sort((a,b) => b.score - a.score);
    renderTable(sortedScores);
});

function renderTable(data) {
    const table = document.getElementById("menu-leaderboard");
    table.innerHTML = "<tr><th>#</th><th>Oyuncu</th><th style='text-align:right'>Skor</th></tr>";
    data.forEach((s, i) => {
        table.innerHTML += `<tr><td>${i+1}</td><td>${s.name}</td><td class='score-val'>${s.score}</td></tr>`;
    });
}

function showScreen(id) {
    document.querySelectorAll('.overlay').forEach(s => s.classList.add('hidden'));
    if(id !== 'none') document.getElementById(id).classList.remove('hidden');
}

function setDifficulty(val, label) {
    gameSpeed = val;
    alert("Zorluk: " + label);
    showScreen('menu-screen');
}

function checkNameAndStart() {
    if(!playerName) {
        playerName = prompt("Adƒ±nƒ±z:");
        if(!playerName) playerName = "Oyuncu" + Math.floor(Math.random()*100);
        localStorage.setItem("snakeName", playerName);
    }
    startGame();
}

function startGame() {
    showScreen('none');
    isGameOver = false;
    score = 0;
    document.getElementById("hud").innerText = "Puan: 0";
    direction = "RIGHT";
    snake = [{x: 9*box, y: 10*box}, {x: 8*box, y: 10*box}];
    spawnFood();
    bgMusic.play().catch(()=>{});
    if(gameInterval) clearInterval(gameInterval);
    gameInterval = setInterval(draw, gameSpeed);
}

function spawnFood() {
    food = { x: Math.floor(Math.random()*19)*box, y: Math.floor(Math.random()*19)*box };
}

document.addEventListener("keydown", e => {
    const k = e.keyCode;
    if(k == 37 && direction != "RIGHT") direction = "LEFT";
    else if(k == 38 && direction != "DOWN") direction = "UP";
    else if(k == 39 && direction != "LEFT") direction = "RIGHT";
    else if(k == 40 && direction != "UP") direction = "DOWN";
});

function draw() {
    if(assets.bg) ctx.drawImage(bgImg, 0, 0, 400, 400);
    else { ctx.fillStyle = "#111"; ctx.fillRect(0,0,400,400); }

    snake.forEach((p, i) => {
        let img = null; let angle = 0;
        if(i === 0) {
            img = assets.head ? headImg : null;
            if(direction==="UP") angle=-Math.PI/2; else if(direction==="DOWN") angle=Math.PI/2;
            else if(direction==="LEFT") angle=Math.PI;
        } else if(i === snake.length-1) {
            img = assets.tail ? tailImg : null;
            let prev = snake[i-1];
            if(prev.x < p.x) angle=Math.PI; else if(prev.x > p.x) angle=0;
            else if(prev.y < p.y) angle=-Math.PI/2; else if(prev.y > p.y) angle=Math.PI/2;
        } else { img = assets.body ? bodyImg : null; }

        if(img) {
            ctx.save(); ctx.translate(p.x+10, p.y+10); ctx.rotate(angle);
            ctx.drawImage(img, -10, -10, 20, 20); ctx.restore();
        } else {
            ctx.fillStyle = i===0 ? "#39ff14" : "#28b40f"; ctx.fillRect(p.x, p.y, 20, 20);
        }
    });

    if(assets.apple) ctx.drawImage(appleImg, food.x, food.y, 20, 20);
    else { ctx.fillStyle = "red"; ctx.fillRect(food.x, food.y, 20, 20); }

    let headX = snake[0].x; let headY = snake[0].y;
    if(direction === "LEFT") headX -= box; else if(direction === "UP") headY -= box;
    else if(direction === "RIGHT") headX += box; else if(direction === "DOWN") headY += box;

    if(headX<0 || headX>=400 || headY<0 || headY>=400 || snake.some(p=>p.x===headX && p.y===headY)) {
        gameOver(); return;
    }

    if(headX===food.x && headY===food.y) {
        score++; eatSound.play().catch(()=>{});
        document.getElementById("hud").innerText = "Puan: " + score;
        spawnFood();
    } else { snake.pop(); }
    snake.unshift({x: headX, y: headY});
}

function gameOver() {
    isGameOver = true;
    clearInterval(gameInterval);
    const finalScore = score;
    document.getElementById("final-score-text").innerText = "Skorun: " + finalScore;
    
    // SKOR KAYDETME MANTIƒûI: Herkesin tek bir rekoru olsun
    db.ref('scores').push({
        name: playerName,
        score: parseInt(finalScore)
    });

    showScreen('gameover-screen');
}

function resetGame() { startGame(); }
function backToMenu() { showScreen('menu-screen'); }
</script>
</body>
</html>