<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Yılan - Mobil Uyumlu</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; touch-action: none; }
        #game-wrapper { position: relative; border: 5px solid #333; box-shadow: 0 0 30px rgba(0,255,0,0.4); border-radius: 8px; width: 400px; height: 400px; background: #111; max-width: 95vw; max-height: 95vw; }
        canvas { display: block; background: #111; border-radius: 5px; width: 100%; height: 100%; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; padding: 20px; box-sizing: border-box; text-align: center; }
        .hidden { display: none; }
        h1 { color: #39ff14; text-shadow: 0 0 10px #39ff14; font-size: 1.8em; margin-bottom: 10px; }
        .menu-buttons { display: flex; flex-direction: column; gap: 8px; width: 100%; align-items: center; }
        button { background: #39ff14; border: none; padding: 10px 15px; font-weight: bold; cursor: pointer; border-radius: 5px; width: 180px; font-size: 0.9em; transition: 0.2s; color: #000; }
        button:hover { background: #fff; transform: scale(1.05); }
        #hud { position: absolute; top: 10px; left: 10px; font-size: 16px; font-weight: bold; color: #39ff14; z-index: 5; text-shadow: 1px 1px 2px #000; }
        .leaderboard-container { width: 100%; margin-top: 10px; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 5px; max-height: 120px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
    </style>
</head>
<body>

<div id="game-wrapper">
    <div id="hud">Puan: 0 <span id="active-mod-text" style="margin-left:10px; color:#aaa;">Mod: KLASİK</span></div>
    
    <div id="menu-screen" class="overlay">
        <h1>PİKSEL YILAN PRO</h1>
        <div class="menu-buttons">
            <button onclick="checkNameAndStart()">OYNA</button>
            <button onclick="showScreen('mods-screen')" style="background:#00d4ff">MODLAR</button>
            <button onclick="showScreen('settings-screen')" style="background:#888">AYARLAR</button>
        </div>
        <div class="leaderboard-container"><table id="menu-leaderboard"></table></div>
    </div>

    <div id="mods-screen" class="overlay hidden">
        <h1>MOD SEÇ</h1>
        <div class="menu-buttons">
            <button onclick="selectMod('KLASİK')">KLASİK</button>
            <button onclick="selectMod('NEON')" style="background:#ff00ff; color:white;">NEON GECESİ</button>
            <button onclick="selectMod('HIZ')" style="background:#ff4400; color:white;">HIZ TRENİ</button>
            <button onclick="selectMod('PORTAL')" style="background:#0044ff; color:white;">PORTAL</button>
            <button onclick="showScreen('menu-screen')" style="background:#555; color:white;">GERİ</button>
        </div>
    </div>

    <div id="settings-screen" class="overlay hidden">
        <h1>AYARLAR</h1>
        <div class="menu-buttons">
            <button onclick="changeName()">İSİM DEĞİŞTİR</button>
            <button onclick="showScreen('menu-screen')" style="background:#555; color:white;">GERİ</button>
        </div>
    </div>

    <div id="gameover-screen" class="overlay hidden">
        <h1 style="color:#ff4444;">OYUN BİTTİ</h1>
        <h2 id="final-score-text">0</h2>
        <div class="menu-buttons">
            <button onclick="startGame()">TEKRAR OYNA</button>
            <button onclick="showScreen('menu-screen')" style="background:#555; color:white;">ANA MENÜ</button>
        </div>
    </div>

    <canvas id="gameCanvas" width="400" height="400"></canvas>
</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const box = 20;

let gameInterval = null;
let score = 0;
let snake = [];
let food = {x:0, y:0};
let direction = "RIGHT";
let nextDirection = "RIGHT"; 
let currentMod = 'KLASİK';
let playerName = localStorage.getItem("snakeName");

// RESİMLER
const headUp = new Image(); headUp.src = 'kafa_yukari.png';
const headDown = new Image(); headDown.src = 'kafa_asagi.png';
const headLeft = new Image(); headLeft.src = 'kafa_sol.png';
const headRight = new Image(); headRight.src = 'kafa_sag.png';
const appleImg = new Image(); appleImg.src = 'elma.png';
const bgImg = new Image(); bgImg.src = 'arka_plan.jpg';

// SES
const yeSes = new Audio('ye.mp3');

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAWdCEJgOQmP-1A4bvYNxmzWsfnfJQ6-vE",
  authDomain: "yilanoyunu-96766.firebaseapp.com",
  databaseURL: "https://yilanoyunu-96766-default-rtdb.firebaseio.com",
  projectId: "yilanoyunu-96766",
  storageBucket: "yilanoyunu-96766.firebasestorage.app",
  messagingSenderId: "87313077711",
  appId: "1:87313077711:web:6b90d8cbff959aa6a8eeba"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Liderlik Tablosu
db.ref('scores').on('value', snap => {
    let scoresMap = {};
    snap.forEach(c => {
        let val = c.val();
        if(!scoresMap[val.name] || val.score > scoresMap[val.name].score) scoresMap[val.name] = val;
    });
    let sorted = Object.values(scoresMap).sort((a,b) => b.score - a.score).slice(0, 5);
    const table = document.getElementById("menu-leaderboard");
    table.innerHTML = "<tr><th>#</th><th>Oyuncu</th><th>Skor</th></tr>";
    sorted.forEach((s, i) => {
        table.innerHTML += `<tr><td>${i+1}</td><td>${s.name}</td><td>${s.score}</td></tr>`;
    });
});

function showScreen(id) {
    document.querySelectorAll('.overlay').forEach(s => s.classList.add('hidden'));
    if(id !== 'none') document.getElementById(id).classList.remove('hidden');
}

function selectMod(m) {
    currentMod = m;
    document.getElementById("active-mod-text").innerText = "Mod: " + m;
    showScreen('menu-screen');
}

function changeName() {
    let n = prompt("Yeni İsminiz:");
    if(n && n.trim() !== "") { 
        playerName = n.trim(); 
        localStorage.setItem("snakeName", playerName); 
    }
}

function checkNameAndStart() {
    if(!playerName || playerName.trim() === "" || playerName === "null") {
        let n = prompt("Devam etmek için lütfen adınızı giriniz:");
        if(!n || n.trim() === "") {
            alert("İsim girmek zorunludur!");
            return;
        }
        playerName = n.trim();
        localStorage.setItem("snakeName", playerName);
    }
    startGame();
}

function spawnFood() {
    food = {
        x: Math.floor(Math.random() * 19) * box,
        y: Math.floor(Math.random() * 19) * box
    };
    for(let segment of snake) {
        if(segment.x === food.x && segment.y === food.y) spawnFood();
    }
}

function startGame() {
    showScreen('none');
    score = 0;
    direction = "RIGHT";
    nextDirection = "RIGHT";
    snake = [
        {x: 9 * box, y: 10 * box},
        {x: 8 * box, y: 10 * box},
        {x: 7 * box, y: 10 * box}
    ];
    spawnFood();
    if(gameInterval) clearInterval(gameInterval);
    let speed = currentMod === 'HIZ' ? 70 : 120;
    gameInterval = setInterval(draw, speed);
}

// KLAVYE KONTROLLERİ
document.addEventListener("keydown", e => {
    if(e.keyCode == 37 && direction != "RIGHT") nextDirection = "LEFT";
    else if(e.keyCode == 38 && direction != "DOWN") nextDirection = "UP";
    else if(e.keyCode == 39 && direction != "LEFT") nextDirection = "RIGHT";
    else if(e.keyCode == 40 && direction != "UP") nextDirection = "DOWN";
});

// MOBİL KAYDIRMA (SWIPE) KONTROLLERİ
let touchStartX = 0;
let touchStartY = 0;

document.addEventListener('touchstart', e => {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
}, false);

document.addEventListener('touchend', e => {
    let touchEndX = e.changedTouches[0].screenX;
    let touchEndY = e.changedTouches[0].screenY;
    handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
}, false);

function handleSwipe(startX, startY, endX, endY) {
    const diffX = endX - startX;
    const diffY = endY - startY;
    // Hangi yönde daha çok kaydırıldığını bul (en az 30px kaydırma şartı)
    if (Math.abs(diffX) > Math.abs(diffY)) {
        if (Math.abs(diffX) > 30) {
            if (diffX > 0 && direction !== "LEFT") nextDirection = "RIGHT";
            else if (diffX < 0 && direction !== "RIGHT") nextDirection = "LEFT";
        }
    } else {
        if (Math.abs(diffY) > 30) {
            if (diffY > 0 && direction !== "UP") nextDirection = "DOWN";
            else if (diffY < 0 && direction !== "DOWN") nextDirection = "UP";
        }
    }
}

function draw() {
    direction = nextDirection;
    
    if(currentMod === 'NEON') {
        ctx.fillStyle = "#000";
        ctx.fillRect(0,0,400,400);
    } else if(bgImg.complete && bgImg.naturalWidth !== 0) {
        ctx.drawImage(bgImg, 0, 0, 400, 400);
    } else {
        ctx.fillStyle = "#111";
        ctx.fillRect(0,0,400,400);
    }

    if(appleImg.complete && appleImg.naturalWidth !== 0) {
        ctx.drawImage(appleImg, food.x, food.y, box, box);
    } else {
        ctx.fillStyle = "red";
        ctx.fillRect(food.x, food.y, box, box);
    }

    snake.forEach((p, i) => {
        if(i === 0) {
            let img = headRight;
            if(direction === "UP") img = headUp;
            else if(direction === "DOWN") img = headDown;
            else if(direction === "LEFT") img = headLeft;
            
            if(img.complete && img.naturalWidth !== 0) {
                ctx.drawImage(img, p.x - 5, p.y - 5, box + 10, box + 10);
            } else {
                ctx.fillStyle = "yellow";
                ctx.fillRect(p.x, p.y, box, box);
            }
        } else {
            ctx.fillStyle = (currentMod === 'NEON') ? "#ff00ff" : "#28b40f";
            ctx.fillRect(p.x, p.y, box-1, box-1);
        }
    });

    let headX = snake[0].x;
    let headY = snake[0].y;

    if(direction === "LEFT") headX -= box;
    if(direction === "UP") headY -= box;
    if(direction === "RIGHT") headX += box;
    if(direction === "DOWN") headY += box;

    if(currentMod === 'PORTAL') {
        if(headX < 0) headX = 380; else if(headX > 380) headX = 0;
        if(headY < 0) headY = 380; else if(headY > 380) headY = 0;
    }

    if(currentMod !== 'PORTAL' && (headX < 0 || headX >= 400 || headY < 0 || headY >= 400)) {
        return gameOver();
    }

    for(let j=0; j<snake.length; j++) {
        if(headX === snake[j].x && headY === snake[j].y) return gameOver();
    }

    if(headX === food.x && headY === food.y) {
        score++;
        yeSes.play().catch(()=>{}); 
        spawnFood();
    } else {
        snake.pop();
    }

    snake.unshift({x: headX, y: headY});
    document.getElementById("hud").innerHTML = `Puan: ${score} <span style="font-size:11px; margin-left:10px;">Mod: ${currentMod}</span>`;
}

function gameOver() {
    clearInterval(gameInterval);
    document.getElementById("final-score-text").innerText = "Skor: " + score;
    db.ref('scores').push({name: playerName, score: score});
    showScreen('gameover-screen');
}
</script>
</body>
</html>
